<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ehworld</title>
    <link rel="icon" href="../static/img/icon.png" type="image">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="../static/css/avatar.css">
    <link rel="stylesheet" href="../static/css/post.css">
    <link rel="stylesheet" href="../static/css/header.css">
    <link rel="stylesheet" href="../static/css/search.css">
    <link rel="stylesheet" href="../static/css/video.css">
    <link rel="stylesheet" href="../static/css/chat.css">
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="../static/js/search.js"></script>
    <script src="../static/js/video.js"></script>
    <script src="../static/js/notifications.js"></script>
    
    <header class="header">
        <a href="/" class="logo">
            <img src="../static/img/EhWorld.svg" width="148">
        </a>

        <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    
        <div class="nav-links" id="navLinks">
            <a href="/">Главная</a>
            <a href="/feed">Лента</a>
            <a href="/shop">Магазин</a>
            <a href="/upload">Загрузить</a>
        </div>
        
        <div class="search-container">
            <div class="search-box-container">
                <input 
                    id="searchInput"
                    type="search" 
                    class="search-box" 
                    placeholder="Поиск..."
                >
                <div class="search-results" id="searchResults"></div>
            </div>

            <div class="sign-in">
                <button class="sign-in-button" onclick="window.location.href='/'">Войти</button>
            </div>
        </div>
    </header>

    <div class="container-md post-container">
        <div class="post-card" data-post-id="1">
            <div class="post-header">
                <img src="{{ .File.AuthorProfileImageURL }}" alt="Аватар" class="post-avatar" onclick="window.location.href='/user/{{ .File.AuthorName }}'">
                <div>
                    <div class="username-badge">
                        <div class="post-author" onclick="window.location.href='/user/{{ .File.AuthorName }}'">{{ .File.AuthorName }}</div>
                        {{ if hasBadge .File.UserID }}
                        <img src=" {{ .File.Badge }}" alt="Badge" class="user-badge" width="20" height="20">
                        {{ end }}
                    </div>
                    <span class="post-time">{{ formatTimeAgo .File.UploadedAt}}</span>
                </div>
            </div>
            
            <div class="media-container">

                {{ if eq .File.Type "clip" }}

                    <div class="clip-embed">
                        {{ .File.FileName | safeHTML }}
                    </div>

                {{ else if isVideo .File.FileName }}
                <div class="video-container" >
                    <video id="mainVideo" poster="../static/uploads/{{ .File.Thumbnail }}">
                        <source src="../static/uploads/{{ .File.FileName }}" type="video/mp4">
                    </video>
                    
                    <div class="video-loading">
                        <div class="video-loading-spinner"></div>
                    </div>
                    
                    <button class="video-play-btn"></button>
                    
                    <div class="video-controls">
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                        </div>
                        
                        <div class="control-buttons">
                            <div class="left-controls">
                                <button class="control-btn play-pause-btn">
                                    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                </button>
                                
                                <div class="volume-container">
                                    <button class="control-btn volume-btn">
                                        <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                                    </button>
                                    <div class="volume-slider">
                                        <div class="volume-level"></div>
                                    </div>
                                </div>
                                
                                <div class="video-time">
                                    <span class="current-time">0:00</span>
                                    <span class="time-separator">/</span>
                                    <span class="duration">0:00</span>
                                </div>
                            </div>
                            
                            <div class="right-controls">
                                <!-- <button class="control-btn settings-btn">
                                    <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                                </button> -->
                                
                                <button class="control-btn fullscreen-btn">
                                    <svg class="fullscreen-open" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                                    <svg class="fullscreen-close" viewBox="0 0 24 24" style="display:none;"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    {{ if not .File.IsModerated }}
                    <img class="blurred-thumbnail" src="../static/uploads/{{ .File.FileName }}" alt="{{ .File.Title }}" style="filter: blur(30px);">
                    {{ end }}
                </div>
                
                {{ else }}
                <img src="../static/uploads/{{ .File.FileName }}" alt="{{ .File.Title }}" {{ if not .File.IsModerated }}style="filter: blur(10px);"{{ end }}>
                {{ end }}
                {{ if not .File.IsModerated }}
                <div class="moderation-overlay">
                    <div class="moderation-warning">
                        <p>Контент еще не прошел модерацию</p>
                        <button id="continueBtn">Продолжить</button>
                    </div>
                </div>
                {{ end }}
            </div>
            
            <div class="post-footer">
                <div class="post-caption">
                    {{ .File.Title | safeHTML }}
                </div>

                {{ if hasDescription .File.ID }}
                    <div class="post-description">
                        {{ .File.Description | safeHTML }}
                    </div>
                {{ end }}

                <div class="post-stats">
                    <div class="reactions-container">
                        <div class="like-container" id="like-container">
                            <button id="likeBtn" class="like-btn {{ if .HasLiked }}liked{{ end }}">
                                <svg width="24" height="24" viewBox="0 0 24 24">
                                    <path d="M16.5,3C13.605,3,12,5.09,12,5.09S10.395,3,7.5,3C4.462,3,2,5.462,2,8.5c0,4.171,4.912,8.8,10,12.5 c5.088-3.7,10-8.329,10-12.5C22,5.462,19.538,3,16.5,3z" fill="#65676B"/>
                                </svg>
                            </button>
                            <span class="like-count">{{ .File.Likes }}</span>
                        </div>

                        <div class="fuckyou-container" id="fuckyou-container">
                            <button id="fuckyouBtn" class="fuckyou-btn {{ if .HasFuckYou }}fuckyou{{ end }}">
                                <svg width="24" height="24" viewBox="0 0 128 128">
                                    <path d="M50.98 122.96c-3.16 0-6.86-1.72-6.86-6.57c0-5.09-.42-10.72-5.45-13.19c-3.46-1.7-12.44-13.2-13.11-22.8c-.4-5.7 1.91-6.53 6.09-8.03c.42-.15.85-.3 1.28-.46c1.07-.4 1.07-.4.93-8.93c0-5.96 2.32-9.28 7.1-10.13c.47-.08.98-.12 1.53-.12c1.71 0 3.47.41 4.75.7c.89.21 1.53.35 2.05.35a2.68 2.68 0 0 0 2.75-2.32c.01-.06.01-.11.01-.17l.07-38c0-3.62 2.15-7.52 6.87-7.52c4.44 0 7.09 2.8 7.09 7.5l.84 37.15c0 .09.01.18.03.27c.33 1.59.68 2.51 1.61 2.79c.3.09.61.13.94.13c.59 0 1.15-.13 1.79-.29c.83-.2 1.86-.45 3.29-.45c.87 0 1.81.09 2.81.28c2.92.54 4.55 2.27 5.86 3.65c.94.99 1.75 1.85 2.87 2.07c.35.07.69.1 1.05.1c.68 0 1.32-.12 2.07-.26c1.19-.23 2.67-.51 5.26-.51c4.33 0 7.99 3.34 7.99 7.28l-.34 29.73c0 3.31-2.94 6.81-4.14 8.17c-3.05 3.43-4.99 7.81-4.99 12.33v2.03c0 4.14-3.98 5.03-7.38 5.05l-34.66.17z" fill="#65676B"/>
                                </svg>
                            </button>
                            <span class="fuckyou-count">{{ .File.Fucks }}</span>
                        </div>
                    </div>
                    
                    <div class="view-count">{{ formatViews .File.Views }}</div>
                </div>
            </div>
        </div>

        <div class="comments-section">
            <h2>Комментарии</h2>
            <form id="commentForm">
                <textarea placeholder="Ваш комментарий..." required></textarea>
                <button type="submit">Отправить</button>
            </form>
            
            <div id="commentsList">
                {{ range .Comments }}
                <div class="comment" data-comment-id="{{ .ID }}">
                    <img src="{{ .AuthorProfileImageURL }}" alt="{{ .AuthorName }}" class="comment-avatar" onclick="window.location.href='/user/{{ .AuthorName }}'">
                    <div class="comment-content">
                        <div class="comment-header">
                            <div class="username-badge-comment">
                                <a href="/user/{{ .AuthorName }}" class="comment-author">{{ .AuthorName }}</a>
                                {{ if hasBadge .AuthorID }}
                                <img src=" {{ .Badge }}" alt="Badge" class="user-badge" width="20" height="20">
                                {{ end }}
                            </div>
                            
                            <span class="comment-time">{{ formatTimeAgo .CreatedAt }}</span>
                            
                            <!-- Кнопка меню (три точки) -->
                            <div class="comment-actions">
                                <button class="comment-menu-toggle">⋮</button>
                                <div class="comment-menu">
                                    <button class="comment-edit" data-comment-id="{{ .ID }}">Изменить</button>
                                    <button class="comment-delete" data-comment-id="{{ .ID }}">Удалить</button>
                                </div>
                            </div>
                        </div>
                        <p class="comment-text">{{ .Text }}</p>
                        <div class="comment-footer">
                            <div class="like-comment" data-comment-id="{{ .ID }}">
                                <button id="likeCommentBtn" class="comment-like {{ if .HasLiked }}liked{{ end }}" onclick="toggleLike(this)">
                                    <svg width="16" height="16" viewBox="0 0 24 24">
                                        <path d="M16.5,3C13.605,3,12,5.09,12,5.09S10.395,3,7.5,3C4.462,3,2,5.462,2,8.5c0,4.171,4.912,8.8,10,12.5 c5.088-3.7,10-8.329,10-12.5C22,5.462,19.538,3,16.5,3z" fill="#65676B"/>
                                    </svg>
                                </button>
                                <span id="commentLikesCount">{{ .Likes }}</span>
                            </div>
                            
                        </div>

                        <div class="comment-reply-form" data-parent-id="{{ .ID }}" style="display: none;">
                            <textarea placeholder="Ваш ответ..." class="reply-textarea"></textarea>
                            <div class="reply-controls">
                                <button class="btn-send-reply">Отправить</button>
                                <button class="btn-cancel-reply">Отмена</button>
                            </div>
                        </div>
                    </div>
                </div>
                {{ end }}
            </div>
        </div>
    </div>

    <div class="chat-widget">
        <button class="chat-button" id="chatButton">
            <img src="../static/img/comments.svg" alt="Chat" width="24" height="24">
        </button>
        <div class="chat-container" id="chatContainer">
            <iframe src="https://www.twitch.tv/embed/ehchobyah/chat?parent=ehworld.ru"
                    height="200"
                    width="600">
            </iframe>
            <button class="close-chat" id="closeChat">-</button>
        </div>
    </div>

    <script>
    // Лайки
    document.getElementById('like-container').addEventListener('click', function() {
        window.location.href="/";
    });

    // Лайк комментария
    document.querySelectorAll('.like-comment').forEach(btn => {
        btn.addEventListener('click', function() {
            window.location.href="/";
        });
    });

    // Отправка комментария
    document.getElementById('commentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        window.location.href="/";
    });

    // Обработчик для среднего пальца
    document.getElementById('fuckyou-container').addEventListener('click', function() {
        window.location.href="/";
    });
    // Обработка кнопки "Продолжить" для непромодерированного контента
    document.getElementById('continueBtn')?.addEventListener('click', function() {
        document.querySelector('.moderation-overlay').style.display = 'none';
        document.querySelector('.media-container video, .media-container img').style.filter = 'none';
        if (document.querySelector('.blurred-thumbnail') != null) document.querySelector('.blurred-thumbnail').style.display = 'none';
    });
    </script>

    <script src="../static/js/header.js"></script>
    <script src="../static/js/chat.js"></script>
</body>
</html>